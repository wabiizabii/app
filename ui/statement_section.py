# ui/statement_section.py (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)

import streamlit as st
import pandas as pd
import hashlib
from datetime import datetime
import uuid
import traceback

from config import settings
from core import gs_handler, statement_processor, analytics_engine

def render_statement_section():
    with st.expander("üìÇ Ultimate Chart Dashboard Import & Processing", expanded=False):
        st.markdown("### üìä ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Statement ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö")
        st.subheader("üì§ ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î Statement Report (CSV)")

        if 'uploader_key' not in st.session_state:
            st.session_state.uploader_key = 0
        
        uploaded_file = st.file_uploader(
            "‡∏•‡∏≤‡∏Å‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå Statement Report (CSV) ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà",
            type=["csv"],
            key=f"statement_uploader_{st.session_state.uploader_key}"
        )

        if uploaded_file:
            if st.session_state.get('processed_filename') != uploaded_file.name:
                st.session_state['extracted_data'] = None

            try:
                st.session_state['extracted_data'] = statement_processor.extract_data_from_report_content(uploaded_file.getvalue())
                st.session_state['processed_filename'] = uploaded_file.name
                file_content_bytes = uploaded_file.getvalue()
                st.session_state['file_info_to_save'] = {
                    "name": uploaded_file.name, 
                    "size": uploaded_file.size, 
                    "content_bytes": file_content_bytes,
                    "hash": hashlib.md5(file_content_bytes).hexdigest()
                }
            except Exception as e:
                st.error(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå: {e}")
                st.session_state['extracted_data'] = None

        if st.session_state.get('extracted_data'):
            st.subheader("üìä ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÑ‡∏ü‡∏•‡πå (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)")

            extracted = st.session_state.get('extracted_data', {})
            deals_df = extracted.get('deals', pd.DataFrame())
            orders_df = extracted.get('orders', pd.DataFrame())
            positions_df = extracted.get('positions', pd.DataFrame())
            balance_summary = extracted.get('balance_summary', {})
            results_summary = extracted.get('results_summary', {})

            if deals_df.empty:
                st.error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 'Deals' ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå")
                return

            st.success(f"‚úÖ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!")
            
            deposit_deals_df = deals_df[deals_df['Comment_Deal'].str.lower().str.contains('deposit', na=False)] if 'Comment_Deal' in deals_df.columns else pd.DataFrame()
            withdrawal_deals_df = deals_df[deals_df['Comment_Deal'].str.lower().str.contains('withdraw', na=False)] if 'Comment_Deal' in deals_df.columns else pd.DataFrame()

            st.markdown("##### ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏û‡∏ö")
            count_cols = st.columns(5)
            count_cols[0].metric("Deals ‡∏ó‡∏µ‡πà‡∏û‡∏ö", f"{len(deals_df)} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")
            count_cols[1].metric("Orders ‡∏ó‡∏µ‡πà‡∏û‡∏ö", f"{len(orders_df)} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")
            count_cols[2].metric("Positions ‡∏ó‡∏µ‡πà‡∏û‡∏ö", f"{len(positions_df)} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")
            count_cols[3].metric("Deposit ‡∏ó‡∏µ‡πà‡∏û‡∏ö", f"{len(deposit_deals_df)} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")
            count_cols[4].metric("Withdrawal ‡∏ó‡∏µ‡πà‡∏û‡∏ö", f"{len(withdrawal_deals_df)} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")
            
            st.markdown("---")

            st.markdown("##### ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô (Financial Summary)")
            sum_cols = st.columns(5)
            sum_cols[0].metric("Equity", f"${balance_summary.get('equity', 0.0):,.2f}")
            sum_cols[1].metric("Balance", f"${balance_summary.get('balance', 0.0):,.2f}")
            sum_cols[2].metric("Profit", f"${results_summary.get('Total_Net_Profit', 0.0):,.2f}", delta=f"{results_summary.get('Total_Net_Profit', 0.0):,.2f}")
            sum_cols[3].metric("Deposit", f"${balance_summary.get('deposit', 0.0):,.2f}")
            sum_cols[4].metric("Withdrawal", f"${balance_summary.get('withdrawal', 0.0):,.2f}")

            st.info("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏´‡∏≤‡∏Å‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å")

            st.markdown("---")
            st.subheader("üíæ ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")
            if st.button("‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Confirm & Save)"):
                try:
                    active_portfolio_id = st.session_state.get('active_portfolio_id_gs')
                    active_portfolio_name = st.session_state.get('active_portfolio_name_gs')
                    file_info = st.session_state.get('file_info_to_save', {})
                    import_batch_id = str(uuid.uuid4())
                    has_errors = False

                    if not active_portfolio_id:
                        st.error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å")
                        st.stop()
                    
                    with st.spinner("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏µ‡∏ï‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î..."):
                        gc = gs_handler.get_gspread_client()
                        if not gc:
                            st.error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Client ‡πÑ‡∏î‡πâ")
                            st.stop()

                        ws_dict, setup_error = gs_handler.setup_and_get_worksheets(gc)
                        if setup_error:
                            st.error(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ä‡∏µ‡∏ï: {setup_error}")
                            st.stop()
                        
                        ok_d, _, _ = gs_handler.save_deals_to_actual_trades(ws_dict.get(settings.WORKSHEET_ACTUAL_TRADES), deals_df, active_portfolio_id, active_portfolio_name, file_info.get('name'), import_batch_id)
                        ok_o, _, _ = gs_handler.save_orders_to_actul_orders(ws_dict.get(settings.WORKSHEET_ACTUAL_ORDERS), orders_df, active_portfolio_id, active_portfolio_name, file_info.get('name'), import_batch_id)
                        ok_p, _, _ = gs_handler.save_positions_to_actul_positions(ws_dict.get(settings.WORKSHEET_ACTUAL_POSITIONS), positions_df, active_portfolio_id, active_portfolio_name, file_info.get('name'), import_batch_id)
                        ok_s, _ = gs_handler.save_results_summary_to_gsheets(ws_dict.get(settings.WORKSHEET_STATEMENT_SUMMARIES), balance_summary, results_summary, active_portfolio_id, active_portfolio_name, file_info.get('name'), import_batch_id)
                        
                        if not all([ok_d, ok_o, ok_p, ok_s]): has_errors = True

                        history_log = {
                            "UploadTimestamp": datetime.now().strftime("%Y-%m-%d %H:%M:%S"), "PortfolioID": active_portfolio_id, 
                            "PortfolioName": active_portfolio_name, "FileName": file_info.get('name'), 
                            "FileSize": file_info.get('size'), "FileHash": file_info.get('hash'),
                            "Status": "Success" if not has_errors else "Failed", "ImportBatchID": import_batch_id, "Notes": ""
                        }
                        gs_handler.save_upload_history(ws_dict.get(settings.WORKSHEET_UPLOAD_HISTORY), history_log)
                    st.success("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!")

                    with st.spinner("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Dashboard..."):
                        gs_handler.load_actual_trades_from_gsheets.clear()
                        gs_handler.load_statement_summaries_from_gsheets.clear()
                        gs_handler.load_portfolios_from_gsheets.clear()
                        all_trades_df = gs_handler.load_actual_trades_from_gsheets()
                        all_summaries_df = gs_handler.load_statement_summaries_from_gsheets()
                        all_portfolios_df = gs_handler.load_portfolios_from_gsheets()
                        
                        latest_stats = analytics_engine.get_full_dashboard_stats(all_trades_df, all_summaries_df, active_portfolio_id)
                        portfolio_details = all_portfolios_df[all_portfolios_df['PortfolioID'] == active_portfolio_id].iloc[0].to_dict() if not all_portfolios_df[all_portfolios_df['PortfolioID'] == active_portfolio_id].empty else {}
                        
                        dashboard_payload = {
                            "PortfolioID": active_portfolio_id, "PortfolioName": active_portfolio_name,
                            "LastUpdated": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                            "ProgramType": portfolio_details.get("ProgramType", ""), "Status": portfolio_details.get("Status", ""),
                            "CurrentBalance": latest_stats.get('total_net_profit', 0) + float(portfolio_details.get("InitialBalance", 0)),
                            "TotalNetProfit": latest_stats.get('total_net_profit', 0),
                            "TotalDeposits": all_summaries_df[all_summaries_df['PortfolioID'] == active_portfolio_id]['Deposit'].sum(),
                            "TotalWithdrawals": all_summaries_df[all_summaries_df['PortfolioID'] == active_portfolio_id]['Withdrawal'].sum(),
                        }
                        
                        if gs_handler.update_dashboard_sheet(active_portfolio_id, dashboard_payload):
                            st.success("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Dashboard ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!")
                        else:
                            st.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Dashboard")

                    st.balloons()
                    st.success("‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå!")
                    
                    st.session_state['extracted_data'] = None
                    st.session_state.uploader_key += 1
                    st.rerun()

                except Exception as e:
                    st.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")
                    st.exception(e)